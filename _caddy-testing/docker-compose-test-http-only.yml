## Test: HTTP-only Routes Support
# Tests that http:// prefix routes go to HTTP-only server (srv2)
# while regular routes go to HTTPS server (srv1)

services:
  caddy:
    image: caddy:latest
    container_name: caddy-http-test
    restart: unless-stopped
    network_mode: host
    command: caddy run --config /etc/caddy/caddy.json
    volumes:
      - ./test-http-only-config.json:/etc/caddy/caddy.json:ro
      - caddy_data:/data
      - caddy_config:/config

  caddy-agent:
    image: mcsdodo/caddy-agent:latest
    container_name: caddy-agent-http-test
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CADDY_URL=http://localhost:2019
      - AGENT_ID=http-test
      - DOCKER_LABEL_PREFIX=caddy
    depends_on:
      - caddy

  # HTTP-only route (should go to srv2 - HTTP server)
  test-http-only:
    image: hashicorp/http-echo
    container_name: test-http-only
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:9300
      - -text=SUCCESS - HTTP-only route (srv2)
    labels:
      caddy: http://httponly.test.lan
      caddy.reverse_proxy: "{{upstreams 9300}}"

  # HTTPS route (should go to srv1 - HTTPS server)
  test-https:
    image: hashicorp/http-echo
    container_name: test-https
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:9301
      - -text=SUCCESS - HTTPS route (srv1)
    labels:
      caddy: https.test.lan
      caddy.reverse_proxy: "{{upstreams 9301}}"

volumes:
  caddy_data:
  caddy_config:
