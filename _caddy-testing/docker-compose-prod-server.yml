services:
  caddy:
    image: caddy-cloudflare:latest
    container_name: caddy-server
    restart: unless-stopped
    network_mode: host
    environment:
      - CF_API_TOKEN=${CF_API_TOKEN}
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "2019:2019"
    volumes:
      - caddy_data:/data
      - caddy_config:/config

  caddy-agent:
    image: caddy-agent:phase3
    container_name: caddy-agent-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - AGENT_MODE=server
      - AGENT_ID=host1-server
      - CADDY_API_URL=http://localhost:2019
      - DOCKER_LABEL_PREFIX=caddy
    depends_on:
      - caddy

  # Test service - backward compatibility (simple labels)
  test-local:
    image: hashicorp/http-echo
    container_name: test-local
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:8081
      - -text=Hello from host1 - simple label
    labels:
      caddy: test-local.lan
      caddy.reverse_proxy: 192.168.0.96:8081

  # Phase 1 test - numbered labels
  test-numbered:
    image: hashicorp/http-echo
    container_name: test-numbered
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:8082
      - -text=Route 0 from host1
    labels:
      caddy_0: test-numbered-0.lan
      caddy_0.reverse_proxy: 192.168.0.96:8082
      caddy_1: test-numbered-1.lan
      caddy_1.reverse_proxy: 192.168.0.96:8082

  # Phase 1 test - multiple domains
  test-multi-domain:
    image: hashicorp/http-echo
    container_name: test-multi-domain
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:8083
      - -text=Multi-domain service on host1
    labels:
      caddy: test-multi-a.lan, test-multi-b.lan, test-multi-c.lan
      caddy.reverse_proxy: 192.168.0.96:8083

  # Phase 2 test - real-world wildcard certificate with Cloudflare DNS
  test-wildcard-cert:
    image: hashicorp/http-echo
    container_name: test-wildcard-cert
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:8084
      - -text=Phase 2 - Real wildcard cert with Cloudflare DNS on *.lacny.me
    labels:
      # Global settings
      caddy_0.email: ${EMAIL}
      caddy_0.auto_https: prefer_wildcard

      # Wildcard snippet definition
      caddy_1: (wildcard)
      caddy_1.tls.dns: "cloudflare ${CF_API_TOKEN}"
      caddy_1.tls.resolvers: 1.1.1.1 1.0.0.1
      caddy_1.handle.abort: ""

      # Wildcard domain using snippet (handle.abort only - for cert acquisition)
      caddy_10: "*.lacny.me"
      caddy_10.import: wildcard

      # Specific test subdomain with TLS DNS challenge
      caddy_20: test-phase2.lacny.me
      caddy_20.import: wildcard
      caddy_20.reverse_proxy: 192.168.0.96:8084

volumes:
  caddy_data:
  caddy_config:
