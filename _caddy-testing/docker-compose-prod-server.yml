services:
  caddy:
    build:
      context: .
      dockerfile: Dockerfile.Caddy
    image: caddy-docker-proxy:latest
    container_name: caddy-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - TZ=Europe/Bratislava
    labels:
      # Global settings
      caddy_0.email: "${EMAIL}"
      caddy_0.auto_https: prefer_wildcard

      # Wildcard snippet (Cloudflare DNS challenge)
      caddy_1: (wildcard)
      caddy_1.tls.dns: "cloudflare ${CF_API_TOKEN}"
      caddy_1.tls.resolvers: 1.1.1.1 1.0.0.1

      # HTTPS backend snippet (skip TLS verify)
      caddy_2: (https)
      caddy_2.transport: http
      caddy_2.transport.tls: ""
      caddy_2.transport.tls_insecure_skip_verify: ""

      # Setup wildcard domains
      caddy_10: "*.lacny.me"
      caddy_10.import: wildcard

      # Internal certificates for .lan domains (local testing)
      caddy_11: (internal)
      caddy_11.tls: internal

      caddy_12: "*.lan"
      caddy_12.import: internal

      caddy_13: "*.test.lan"
      caddy_13.import: internal

      # Catch-all for .lan domains (HTTP-only)
      caddy_20: http://*.lan
      caddy_20.reverse_proxy: "192.168.0.96:80"

      # Admin API proxy
      caddy_30: ":2020"
      caddy_30.reverse_proxy: "localhost:2019"
      caddy_30.reverse_proxy.header_up: "Host localhost:2019"

  # Server mode agent - uses 'agent' prefix to avoid conflict with caddy-docker-proxy
  caddy-agent-server:
    image: caddy-agent:latest
    container_name: caddy-agent-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CADDY_URL=http://localhost:2019
      - AGENT_ID=host1-server
      - DOCKER_LABEL_PREFIX=agent
      - SNIPPET_API_PORT=8567
      # Recovery mechanism (handles Caddy restarts)
      - HEALTH_CHECK_INTERVAL=5   # Fast detection of missing routes
      - RESYNC_INTERVAL=300       # Fallback periodic resync (5 min)
    labels:
      # Caddy TLS config for *.server.lan (picked up by caddy-docker-proxy)
      caddy_14: "*.server.lan"
      caddy_14.import: internal

  # Backend for server mode test (labels picked up by caddy-agent-server)
  test-server-echo:
    image: hashicorp/http-echo
    command: ["-listen=:9300", "-text=Server mode test - host1"]
    network_mode: host
    labels:
      agent: test.server.lan
      agent.reverse_proxy: "localhost:9300"

volumes:
  caddy_data:
  caddy_config:
