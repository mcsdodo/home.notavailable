services:
  caddy-agent:
    image: caddy-agent:latest
    container_name: caddy-agent-remote3
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CADDY_URL=http://192.168.0.96:2019
      - AGENT_ID=host3-remote
      - HOST_IP=192.168.0.99
      - DOCKER_LABEL_PREFIX=caddy
    # Bridge network with explicit HOST_IP - tests non-auto-detect code path

  # Test service - simple label (backward compatibility)
  test-host3:
    image: hashicorp/http-echo
    container_name: test-host3
    restart: unless-stopped
    ports:
      - "9000:9000"
    command:
      - -listen=:9000
      - -text=Simple label on host3 (bridge)
    labels:
      caddy: test-host3.lan
      caddy.reverse_proxy: "{{upstreams 9000}}"

  # Phase 1 test - combined features (numbered + multiple domains)
  test-combined:
    image: hashicorp/http-echo
    container_name: test-combined
    restart: unless-stopped
    ports:
      - "9001:9001"
    command:
      - -listen=:9001
      - -text=Combined features on host3 (bridge)
    labels:
      caddy_0: host3-combined-a.lan, host3-combined-b.lan
      caddy_0.reverse_proxy: "{{upstreams 9001}}"
      caddy_1: host3-single.lan
      caddy_1.reverse_proxy: "{{upstreams 9001}}"

  # Phase 1 test - mixed simple and numbered
  test-mixed:
    image: hashicorp/http-echo
    container_name: test-mixed
    restart: unless-stopped
    ports:
      - "9002:9002"
    command:
      - -listen=:9002
      - -text=Mixed labels on host3 (bridge)
    labels:
      caddy: host3-simple.lan
      caddy.reverse_proxy: "{{upstreams 9002}}"
      caddy_5: host3-numbered5.lan
      caddy_5.reverse_proxy: "{{upstreams 9002}}"

  # Phase 2 test - transport TLS + handle directives
  test-transport-handle:
    image: hashicorp/http-echo
    container_name: test-transport-handle
    restart: unless-stopped
    ports:
      - "9003:9003"
    command:
      - -listen=:9003
      - -text=Phase 2 - Transport on host3 (bridge)
    labels:
      caddy_30: phase2-transport.lan
      caddy_30.reverse_proxy: "{{upstreams 9003}}"
      caddy_30.transport: http
      caddy_30.transport.tls: ""
      caddy_30.transport.tls_insecure_skip_verify: ""

  # HTTP-only route test - should go to srv2 (HTTP server on :80)
  test-http-only:
    image: hashicorp/http-echo
    container_name: test-http-only
    restart: unless-stopped
    ports:
      - "9300:9300"
    command:
      - -listen=:9300
      - -text=SUCCESS - HTTP-only route (srv2) on host3
    labels:
      caddy: http://httponly.test.lan
      caddy.reverse_proxy: "{{upstreams 9300}}"

  # HTTPS route test - should go to srv1 (HTTPS server on :443)
  test-https:
    image: hashicorp/http-echo
    container_name: test-https
    restart: unless-stopped
    ports:
      - "9301:9301"
    command:
      - -listen=:9301
      - -text=SUCCESS - HTTPS route (srv1) on host3
    labels:
      caddy: https.test.lan
      caddy.reverse_proxy: "{{upstreams 9301}}"
