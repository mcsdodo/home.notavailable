services:
  caddy-agent:
    image: caddy-agent:latest
    container_name: caddy-agent-remote
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CADDY_URL=http://192.168.0.96:2020
      - AGENT_ID=host2-remote
      - DOCKER_LABEL_PREFIX=caddy
      # HOST_IP not set - will auto-detect with network_mode: host
      # Recovery mechanism (handles Caddy restarts)
      - HEALTH_CHECK_INTERVAL=5   # Fast detection of missing routes
      - RESYNC_INTERVAL=300       # Fallback periodic resync (5 min)
    network_mode: host

  # Test service - simple label (backward compatibility)
  test-remote:
    image: hashicorp/http-echo
    container_name: test-remote
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:5678
      - -text=Simple label on host2
    labels:
      caddy: test-remote.lan
      caddy.reverse_proxy: "{{upstreams 5678}}"

  # Phase 1 test - multiple domains (main feature for host2)
  test-multi-host2:
    image: hashicorp/http-echo
    container_name: test-multi-host2
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:5679
      - -text=Multi-domain on host2
    labels:
      caddy: host2-app1.lan, host2-app2.lan
      caddy.reverse_proxy: "{{upstreams 5679}}"

  # Phase 1 test - high numbered labels
  test-high-numbers:
    image: hashicorp/http-echo
    container_name: test-high-numbers
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:5680
      - -text=High numbered routes
    labels:
      caddy_10: host2-route10.lan
      caddy_10.reverse_proxy: "{{upstreams 5680}}"
      caddy_111: host2-route111.lan
      caddy_111.reverse_proxy: "{{upstreams 5680}}"

  # Phase 2 test - snippet import
  test-snippet-import:
    image: hashicorp/http-echo
    container_name: test-snippet-import
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:5681
      - -text=Phase 2 - Snippet import on host2
    labels:
      caddy_20: phase2-import.lan
      caddy_20.reverse_proxy: "{{upstreams 5681}}"

  # Phase 3 test - header manipulation (header_up)
  test-header-manipulation:
    image: hashicorp/http-echo
    container_name: test-header-manipulation
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:5682
      - -text=Phase 3 - Header manipulation on host2
    labels:
      caddy_30: phase3-headers.lan
      caddy_30.reverse_proxy: "{{upstreams 5682}}"
      caddy_30.reverse_proxy.header_up: "-X-Forwarded-For"
      caddy_30.reverse_proxy.header_down: "-Server"

  # Route ordering test - specific route should match before wildcard (*.test.lan)
  test-specific:
    image: hashicorp/http-echo
    container_name: test-specific
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:9100
      - -text=SUCCESS - Specific route matched before wildcard (host2)
    labels:
      caddy: app.test.lan
      caddy.reverse_proxy: "{{upstreams 9100}}"

  # Route ordering test - another specific route
  test-another:
    image: hashicorp/http-echo
    container_name: test-another
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:9101
      - -text=SUCCESS - Another specific route (host2)
    labels:
      caddy: api.test.lan
      caddy.reverse_proxy: "{{upstreams 9101}}"

  # Test - real-world wildcard certificate with Cloudflare DNS
  test-wildcard-cert:
    image: hashicorp/http-echo
    container_name: test-wildcard-cert
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:8084
      - -text=Wildcard cert with Cloudflare DNS on *.lacny.me (host2)
    labels:
      caddy: test-phase2.lacny.me
      caddy.import: wildcard
      caddy.reverse_proxy: "{{upstreams 8084}}"

  # Snippet definitions for host2 (agents only see local containers)
  snippets-host2:
    image: busybox
    container_name: snippets-host2
    restart: "no"
    command: ["sleep", "infinity"]
    network_mode: host
    labels:
      # Internal TLS snippet (for .lan domains)
      caddy_1: (internal)
      caddy_1.tls: internal
      # Custom header snippet (adds X-Custom-Header)
      caddy_2: (custom-header)
      caddy_2.reverse_proxy.header_up: "X-Multi-Import test-value"

  # Multi-import test - uses internal + custom-header snippets
  test-multi-import:
    image: hashicorp/http-echo
    container_name: test-multi-import
    restart: unless-stopped
    network_mode: host
    command:
      - -listen=:9200
      - -text=SUCCESS - Multi-import (internal, custom-header) on host2
    labels:
      caddy: multi-import.test.lan
      caddy.import: internal, custom-header
      caddy.reverse_proxy: "{{upstreams 9200}}"
